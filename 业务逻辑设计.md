# 心迹 (XinJi) 业务逻辑设计

## 一、用户认证模块

1. 发送验证码
2. 登录/注册（验证码登录）
3. 退出登录
4. Token刷新
5. 用户信息查询
6. 用户信息更新
7. 账号注销
8. 数据导出

## 二、日记管理模块

1. 创建日记（支持草稿）
2. 更新日记
3. 删除日记（逻辑删除）
4. 日记列表查询（分页、日期范围、关键词搜索）
5. 日记详情查询
6. 日记内容加密存储

## 三、AI情绪分析模块

1. 提交日记分析请求
2. 异步AI分析处理
3. 查询分析结果
4. AI配额检查（免费用户5次/天，Pro用户1000次/天）
5. 情绪识别（8类情绪：快乐、悲伤、愤怒、恐惧、惊讶、厌恶、中性、焦虑）
6. 认知偏差检测（10种认知偏差模式）
7. 关键词提取
8. 风险等级评估
9. 调节建议生成

## 四、情绪周报模块

1. 获取周报（按周统计）
2. 情绪趋势分析
3. 情绪分布统计
4. 关键词统计（词云）
5. AI生成周报总结
6. 周报缓存机制
7. 异步刷新周报（防抖）

## 五、深度洞察模块（Pro专属）

1. 获取洞察报告（周/月/全部）
2. 情绪模式分析
3. 认知模式分析
4. 成长计划生成
5. 情绪预测
6. 正念练习推荐

## 六、AI心理咨询师模块（Pro专属）

1. 获取近7天日记数量
2. AI对话咨询
3. 基于日记上下文的个性化建议
4. CBT/ACT疗法应用

## 七、订单支付模块

1. 创建订单（月付/季付/年付）
2. 订单列表查询
3. 订单详情查询
4. 取消订单
5. 微信支付预下单
6. 支付回调处理
7. 模拟支付（开发测试）
8. 查询支付状态
9. 自动取消超时订单
10. 会员激活/续期

## 八、心理训练模块

1. 训练项目列表
2. 呼吸冥想
3. 认知重构
4. 情绪命名
5. 感恩练习
6. 小目标设定
7. 呼吸引导

## 九、心灵加油站模块

1. 获取鼓励语录
2. 语录列表查询

## 十、定时任务模块

1. 生成用户周报（每周一）
2. 取消超时订单
3. 会员到期检查

---

## 核心业务流程

### 用户注册登录流程
```
发送验证码 → 验证码登录 → 自动注册/登录 → 生成JWT Token
```

### 日记分析流程
```
创建日记 → 提交分析 → 检查配额 → 异步AI分析 → 更新分析结果 → 触发周报刷新
```

### 周报生成流程
```
日记保存 → 触发周报刷新（防抖） → 读取本周日记 → 统计情绪数据 → AI生成总结 → 保存到MongoDB
```

### 支付流程
```
选择套餐 → 创建订单 → 微信支付 → 支付回调 → 激活会员 → 更新用户状态
```

### AI咨询流程
```
获取近7天日记 → 构建上下文 → 调用AI API → 返回专业建议
```

